# spec-mesh フレームワーク徹底調査計画（v2 - 最適化版）

## 変更履歴

| バージョン | 変更内容 |
|-----------|---------|
| v1 | 初版（86エージェント） |
| v2 | 最適化版（32エージェント、中間レビュー追加） |

---

## 重要な発見：コンテキスト圧迫は問題ではない

**分析結果**:
- add.md実行時のコンテキスト使用量: ~28,680トークン（ピーク時）
- Claude Opus 4.5のコンテキストウィンドウ: 200,000トークン
- **使用率: 14.3%**（ピーク時でも17.5%）
- **残り利用可能: ~171,320トークン**

→ **コンテキスト圧迫の削減は不要**

---

## 調査目的

**ゴール**: ワークフローの明確化による実行精度の向上

**本当の課題**:
1. ワークフローの複雑さ（7ステップ、20+ファイル参照）
2. 循環依存（Vision Specが前提だがvision.mdで作成）
3. 条件分岐の多さ（Step 2で3つの条件分岐）
4. ファイル間のナビゲーション複雑さ

**求める成果**:
1. ワークフロー遷移の明確化
2. 循環依存の解消または明確化
3. 条件分岐の整理・簡素化
4. 整合性の完全な検証

---

## フレームワーク概要

| 項目 | 数値 |
|------|------|
| 総ファイル数 | 94 |
| 総行数 | 19,445行 |
| .mdファイル | 57個 (13,129行) |
| .cjsファイル | 11個 (5,316行) |
| スキル数 | 7 |

### スキル構成
```
spec-mesh/           (ハブ) 10,456行
├── spec-mesh-entry/        1,484行
├── spec-mesh-develop/      1,072行
├── spec-mesh-quality/      1,337行
├── spec-mesh-test/           799行
├── spec-mesh-meta/           630行
└── guide/                    281行
```

---

## v2 改善ポイント

| 項目 | v1 | v2 | 改善効果 |
|------|-----|-----|---------|
| エージェント数 | 86 | 32 | 63%削減、統合容易 |
| 中間レビュー | 0回 | 3回 | 早期問題発見 |
| 成果物フォーマット | 未定義 | 統一 | 統合容易 |
| 優先順位 | なし | 3層 | 重要課題先行 |
| フィードバック | なし | 各Wave後 | 方針調整可能 |

---

## 調査フェーズ構成（v2）

### Phase 1: Discovery（構造把握）✓ 完了
- ファイル構造マッピング ✓
- 参照関係分析 ✓
- コンテキスト使用量分析 ✓ → **問題なし確認**

### Phase 2: Core Analysis（コア分析）
**目的**: 最重要ファイル群を深く調査し、主要問題を特定

### Phase 3: Extended Analysis（拡張分析）
**目的**: 補助ファイル群の調査、Phase 2の発見を踏まえて調整

### Phase 4: Cross-cutting Analysis（横断分析）
**目的**: ワークフロー遷移・整合性・品質の横断検証

### Phase 5: Synthesis（統合・提案）
**目的**: 発見事項の統合と優先順位付きアクションプラン策定

---

## 成果物フォーマット（統一テンプレート）

各エージェントは以下のフォーマットで報告：

```markdown
## [対象ファイル/領域] 調査結果

### サマリー
- 調査範囲:
- 発見した問題数: P1: X, P2: Y, P3: Z

### 問題点

#### [P1] 重大な問題（実行を妨げる）
- **問題**: 説明
- **場所**: ファイル:行番号
- **影響**: 影響範囲
- **改善案**: 具体的な修正案

#### [P2] 中程度の問題（品質に影響）
- ...

#### [P3] 軽微な問題（改善推奨）
- ...

### 良い点（維持すべき）
- ...

### 他ファイルとの関連
- 影響するファイル:
- 依存するファイル:

### 追加調査が必要な領域
- ...
```

---

## Wave 1: Core Analysis（8エージェント）

**目的**: 最重要ファイル群の深層分析
**優先度**: Layer 1（最重要）

### 1A. Constitution 統合調査（2エージェント）

| ID | 対象ファイル | 調査観点 |
|----|-------------|---------|
| 1A-1 | core.md, quality-gates.md | ルール明確さ、ゲート定義、矛盾検出 |
| 1A-2 | spec-creation.md, terminology.md, git-workflow.md | フロー完全性、用語一貫性、Git操作 |

### 1B. Entry Workflows 統合調査（3エージェント）

| ID | 対象ファイル | 調査観点 |
|----|-------------|---------|
| 1B-1 | vision.md, design.md | 新規作成フロー、循環依存問題、分岐ロジック |
| 1B-2 | add.md, issue.md | 機能追加/Issue起点フロー、依存関係、分岐判定 |
| 1B-3 | fix.md, quick.md | バグ修正/軽量フロー、原因分析、スキップ条件 |

### 1C. Shared Workflows 統合調査（3エージェント）

| ID | 対象ファイル | 調査観点 |
|----|-------------|---------|
| 1C-1 | _vision-interview.md, _deep-interview.md | インタビュー完全性、質問網羅性 |
| 1C-2 | _quality-flow.md, _clarify-gate.md | 品質フロー、ゲート判定基準 |
| 1C-3 | impact-analysis.md, _cascade-update.md, _finalize.md | 影響分析、カスケード更新、最終化 |

### Wave 1 成果物
- Constitution の問題点・改善点リスト
- Entry Workflows の問題点・改善点リスト
- Shared Workflows の問題点・改善点リスト
- **循環依存の初期マップ**

### 🔍 中間レビュー 1
Wave 1 完了後に実施：
- [ ] 重大な問題（P1）の確認
- [ ] 調査方針の調整が必要か判断
- [ ] Wave 2 の調査範囲を確定

---

## Wave 2: Extended Analysis（12エージェント）

**目的**: 補助ファイル群の調査 + Wave 1 発見の深掘り
**優先度**: Layer 2（重要）

### 2A. SKILL.md 統合調査（2エージェント）

| ID | 対象ファイル | 調査観点 |
|----|-------------|---------|
| 2A-1 | spec-mesh/SKILL.md, spec-mesh-entry/SKILL.md | ハブルーティング、エントリポイント |
| 2A-2 | 残り5つのSKILL.md | 子スキルのルーティング、整合性 |

### 2B. Develop/Quality/Test/Meta Workflows（4エージェント）

| ID | 対象ファイル | 調査観点 |
|----|-------------|---------|
| 2B-1 | plan.md, tasks.md | 実装計画、タスク分割、進捗追跡 |
| 2B-2 | implement.md, feedback.md | 実装フロー、フィードバック連携 |
| 2B-3 | review.md, clarify.md, lint.md | Multi-Review、曖昧点解消、Lint |
| 2B-4 | e2e.md, test-scenario.md, pr.md, change.md | テスト、PR、Spec変更 |

### 2C. Templates 統合調査（3エージェント）

| ID | 対象ファイル | 調査観点 |
|----|-------------|---------|
| 2C-1 | vision-spec.md, domain-spec.md | Vision/Domain仕様の完全性 |
| 2C-2 | screen-spec.md, feature-spec.md, fix-spec.md | 画面/機能/修正仕様 |
| 2C-3 | inputs/*.md, plan.md, tasks.md, checklist.md | 入力テンプレート、計画・タスク |

### 2D. Scripts 統合調査（3エージェント）

| ID | 対象ファイル | 調査観点 |
|----|-------------|---------|
| 2D-1 | state.cjs, spec-lint.cjs | 状態管理、Lintルール |
| 2D-2 | scaffold-spec.cjs, matrix-ops.cjs, generate-matrix-view.cjs | Spec生成、Matrix操作 |
| 2D-3 | branch.cjs, pr.cjs, lib/*.cjs | Git操作、共通ライブラリ |

### Wave 2 成果物
- SKILL.md ルーティング整合性レポート
- Develop/Quality/Test Workflows の問題点リスト
- Templates の問題点リスト
- Scripts の問題点リスト

### 🔍 中間レビュー 2
Wave 2 完了後に実施：
- [ ] Wave 1 + Wave 2 の発見事項統合
- [ ] 重大な問題のパターン分析
- [ ] Wave 3 の重点領域を決定

---

## Wave 3: Cross-cutting Analysis（8エージェント）

**目的**: 横断的な分析（遷移・整合性・品質）
**優先度**: Layer 3（分析・検証）

### 3A. ワークフロー遷移分析（2エージェント）

| ID | 調査観点 | 対象範囲 |
|----|---------|---------|
| 3A-1 | 遷移マップ + 循環依存 | Entry→Shared→Develop→Test の完全マップ、依存関係 |
| 3A-2 | 分岐ロジック + エラーリカバリ | 全条件分岐、エラー時の復帰経路 |

### 3B. 整合性検証（3エージェント）

| ID | 調査観点 | 対象範囲 |
|----|---------|---------|
| 3B-1 | 用語・パス参照整合性 | 全.mdファイル間の用語統一、リンク切れ |
| 3B-2 | Constitution↔Workflow↔Template | 原則とフローとテンプレートの一致 |
| 3B-3 | SKILL.md↔Workflow↔Script | ルーティングと実装の一致 |

### 3C. 品質評価（3エージェント）

| ID | 調査観点 | 対象範囲 |
|----|---------|---------|
| 3C-1 | プロンプト明確さ + 具体性 | 全Workflowの指示品質 |
| 3C-2 | エッジケース + エラーハンドリング | 例外処理の網羅性 |
| 3C-3 | ユーザー体験 + 実行可能性 | フローの使いやすさ、実行検証 |

### Wave 3 成果物
- **完全なワークフロー遷移マップ**
- **循環依存解消案**
- 整合性検証レポート
- 品質評価レポート

### 🔍 中間レビュー 3
Wave 3 完了後に実施：
- [ ] 全発見事項の統合
- [ ] 優先順位付けの準備
- [ ] Wave 4 の成果物フォーマット確定

---

## Wave 4: Synthesis（4エージェント）

**目的**: 統合と改善提案策定
**優先度**: 最終フェーズ

### 4A. 統合・提案（4エージェント）

| ID | 調査観点 | 成果物 |
|----|---------|--------|
| 4A-1 | 発見事項統合 | 全Waveの発見事項を統合したマスターリスト |
| 4A-2 | 問題点の分類・ランク付け | 重要度別の問題点リスト（P1/P2/P3） |
| 4A-3 | 改善提案の策定 | 各問題点への具体的改善案（ファイル:行指定） |
| 4A-4 | アクションプラン | 影響度×実現容易さマトリックス、優先順位 |

### Wave 4 成果物
- **問題点マスターリスト**（重要度ランク付き）
- **改善提案一覧**（具体的修正案）
- **優先順位付きアクションプラン**

---

## エージェント配分サマリー（v2）

| Wave | フェーズ | エージェント数 | 目的 |
|------|---------|--------------|------|
| Wave 1 | Core Analysis | 8 | Constitution + Entry + Shared Workflows |
| - | 中間レビュー 1 | - | 方針調整 |
| Wave 2 | Extended Analysis | 12 | SKILL.md + Develop系 + Templates + Scripts |
| - | 中間レビュー 2 | - | 発見統合 |
| Wave 3 | Cross-cutting | 8 | 遷移分析 + 整合性 + 品質 |
| - | 中間レビュー 3 | - | 最終準備 |
| Wave 4 | Synthesis | 4 | 統合 + 改善提案 |
| **合計** | | **32** | |

### v1 vs v2 比較

| 項目 | v1 | v2 | 削減率 |
|------|-----|-----|--------|
| 総エージェント数 | 86 | 32 | 63% |
| Constitution | 5 | 2 | 60% |
| SKILL.md | 7 | 2 | 71% |
| Workflows | 25 | 10 | 60% |
| Templates | 8 | 3 | 63% |
| Scripts | 5 | 3 | 40% |
| Guides | 6 | 0* | 100% |
| Phase 3-5 | 26 | 8 | 69% |
| Phase 6 | 4 | 4 | 0% |

*Guides は Wave 2/3 の調査に統合

---

## 実行戦略

### 並列実行ルール

1. **各Wave内**: エージェントは並列実行可能
2. **Wave間**: 順次実行（中間レビューを挟む）
3. **中間レビュー**: 方針調整の判断ポイント

### 中間レビューの判断基準

**調整が必要な場合**:
- P1（重大な問題）が5件以上発見された
- 想定外の構造的問題が見つかった
- 調査範囲の拡大/縮小が必要

**調整内容**:
- 次Wave のエージェント割り当て変更
- 調査観点の追加/削除
- 優先順位の見直し

---

## 期待される成果物

1. **問題点マスターリスト**: 全ファイルの問題点（P1/P2/P3ランク付き）
2. **ワークフロー遷移マップ**: 完全な遷移図・依存関係図
3. **循環依存解消案**: 特定した循環依存の具体的解消提案
4. **整合性レポート**: ファイル間の整合性検証結果・矛盾点
5. **品質評価レポート**: プロンプト品質スコア、改善ポイント
6. **優先順位付きアクションプラン**: 影響度×実現容易さマトリックス

---

## 調査時の評価基準

### 問題の重要度定義

| ランク | 定義 | 例 |
|--------|------|-----|
| **P1** | 実行を妨げる重大な問題 | 循環依存、リンク切れ、矛盾するルール |
| **P2** | 品質に影響する中程度の問題 | 曖昧な指示、不完全なエラー処理 |
| **P3** | 改善推奨の軽微な問題 | 冗長な記述、用語の不統一 |

### 評価チェックリスト

#### 整合性（絶対優先）
- [ ] 用語の一貫性
- [ ] 参照パスの正確性
- [ ] ワークフロー遷移の論理性
- [ ] 原則とフローの一致
- [ ] ルール定義の矛盾有無

#### ワークフロー明確性
- [ ] 開始条件・前提条件の明確さ
- [ ] 分岐ロジックの明確さ
- [ ] 終了条件・成果物の明確さ
- [ ] 循環依存の有無

#### 実用性・品質
- [ ] プロンプトの明確さ（1-5スコア）
- [ ] 実行可能性（Yes/No/要修正）
- [ ] エラーハンドリング（有/無/不十分）
- [ ] エッジケースカバレッジ

---

## 次のステップ

1. ✅ ユーザー確認: この調査計画（v2）で進めてよいか
2. **Wave 1 実行**: Core Analysis（8エージェント並列）
3. **中間レビュー 1**: 方針調整判断
4. **Wave 2 実行**: Extended Analysis（12エージェント並列）
5. **中間レビュー 2**: 発見統合
6. **Wave 3 実行**: Cross-cutting Analysis（8エージェント並列）
7. **中間レビュー 3**: 最終準備
8. **Wave 4 実行**: Synthesis（4エージェント並列）
9. **最終成果物**: 優先順位付きアクションプラン

---

## 計画サマリー（v2）

| 項目 | 内容 |
|------|------|
| 総エージェント数 | **32**（v1から63%削減） |
| 調査対象ファイル | 94ファイル（.md: 57, .cjs: 11） |
| 中間レビュー | **3回**（各Wave後） |
| 成果物フォーマット | **統一テンプレート** |
| 重点調査対象 | Entry + Shared Workflows（Wave 1で先行） |
| 核心的ゴール | ワークフロー明確化 + 問題点・改善点の特定 |
| 最終成果物 | ワークフローマップ + 問題点リスト + 優先順位付きアクションプラン |
