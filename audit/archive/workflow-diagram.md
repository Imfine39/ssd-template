# Workflow Diagram - Spec-Mesh System

**作成日:** 2026-01-01

---

## 1. 全体フロー概要

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SPEC-MESH WORKFLOW SYSTEM                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐                                                            │
│  │   ENTRY     │  vision / add / fix / issue / quick                        │
│  └──────┬──────┘                                                            │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────┐     ┌─────────────────────┐                                │
│  │   SPEC      │────►│  Vision Interview   │ (vision/add のみ)              │
│  │  CREATION   │     │  Deep Interview     │                                │
│  └──────┬──────┘     └─────────────────────┘                                │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────┐                                │
│  │         QUALITY FLOW                     │                                │
│  │  ┌──────────┐  ┌──────────┐  ┌────────┐ │                                │
│  │  │Multi-    │─►│  Lint    │─►│CLARIFY │ │                                │
│  │  │Review    │  │          │  │ GATE   │ │                                │
│  │  └──────────┘  └──────────┘  └────────┘ │                                │
│  └──────┬──────────────────────────────────┘                                │
│         │                                                                    │
│    ┌────┴────┐                                                              │
│    │ BLOCKED │──────────────► clarify ──► Quality Flow へ戻る               │
│    └─────────┘                                                              │
│         │                                                                    │
│    PASSED / PASSED_WITH_DEFERRED                                             │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────┐                                                            │
│  │[HUMAN_     │                                                             │
│  │CHECKPOINT] │                                                             │
│  └──────┬──────┘                                                            │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────┐                                │
│  │          DEVELOPMENT FLOW                │                                │
│  │  ┌──────────┐  ┌──────────┐  ┌────────┐ │                                │
│  │  │  plan    │─►│  tasks   │─►│implement│ │                                │
│  │  └──────────┘  └──────────┘  └────────┘ │                                │
│  └──────┬──────────────────────────────────┘                                │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────┐     ┌─────────────────────┐                                │
│  │    TEST     │────►│    e2e              │                                │
│  │  SCENARIO   │     │  (Chrome Extension) │                                │
│  └──────┬──────┘     └─────────────────────┘                                │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────┐                                                            │
│  │     PR      │────► merge ────► post-merge                                │
│  └─────────────┘                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Entry Point ルーティング

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          ENTRY ROUTING                                    │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  User Request                                                            │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────────────────────────────────────┐                │
│  │              REQUEST CLASSIFICATION                   │                │
│  │                                                       │                │
│  │  「プロジェクトを始めたい」 ──────► vision.md          │                │
│  │  「画面設計」 ────────────────────► design.md          │                │
│  │  「機能を追加」 ──────────────────► add.md             │                │
│  │  「バグを修正」 ──────────────────► fix.md             │                │
│  │  「Issue #N から開始」 ───────────► issue.md           │                │
│  │  「小さな変更」「Quick」 ─────────► quick.md           │                │
│  │  「Specを変更」 ──────────────────► change.md          │                │
│  │                                                       │                │
│  └─────────────────────────────────────────────────────┘                │
│                                                                          │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                  │
│  │   vision    │    │    add      │    │    fix      │                  │
│  │             │    │             │    │             │                  │
│  │ Quick Input │    │ Quick Input │    │ Quick Input │                  │
│  │ (optional)  │    │ (optional)  │    │ (optional)  │                  │
│  │      │      │    │      │      │    │      │      │                  │
│  │      ▼      │    │      ▼      │    │      ▼      │                  │
│  │ Vision Spec │    │Feature Spec │    │  Fix Spec   │                  │
│  │      │      │    │      │      │    │      │      │                  │
│  │      ▼      │    │      ▼      │    │      ▼      │                  │
│  │  Vision     │    │   Deep      │    │   (Root     │                  │
│  │  Interview  │    │  Interview  │    │   Cause)    │                  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                  │
│         │                  │                  │                          │
│         └──────────────────┴──────────────────┘                          │
│                            │                                             │
│                            ▼                                             │
│                     Quality Flow                                         │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Quality Flow 詳細

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          QUALITY FLOW                                     │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Spec Input                                                              │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────────────────────────────────────────┐                │
│  │              MULTI-REVIEW (3観点並列)                │                │
│  │                                                       │                │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │                │
│  │  │Reviewer A│  │Reviewer B│  │Reviewer C│           │                │
│  │  │ 構造・   │  │ 内容・   │  │ 完全性・ │           │                │
│  │  │ 形式     │  │ 整合性   │  │ 網羅性   │           │                │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘           │                │
│  │       └─────────────┼─────────────┘                 │                │
│  │                     ▼                               │                │
│  │              フィードバック統合                       │                │
│  │                     │                               │                │
│  │                     ▼                               │                │
│  │              AI自動修正可能？                         │                │
│  │              ├── YES ──► 自動修正                    │                │
│  │              └── NO ───► 手動修正提案                │                │
│  └─────────────────────┬───────────────────────────────┘                │
│                        │                                                 │
│                        ▼                                                 │
│  ┌─────────────────────────────────────────────────────┐                │
│  │                   LINT                               │                │
│  │                                                       │                │
│  │  • ID命名規則チェック                                  │                │
│  │  • 必須セクション確認                                  │                │
│  │  • 参照整合性検証                                      │                │
│  │  • Matrix整合性検証                                    │                │
│  └─────────────────────┬───────────────────────────────┘                │
│                        │                                                 │
│                        ▼                                                 │
│  ┌─────────────────────────────────────────────────────┐                │
│  │               CLARIFY GATE                           │                │
│  │                                                       │                │
│  │  [NEEDS CLARIFICATION] マーカーをカウント              │                │
│  │                                                       │                │
│  │  ├── Count > 0 ──► BLOCKED                           │                │
│  │  │                    │                               │                │
│  │  │                    ▼                               │                │
│  │  │              clarify.md 実行                       │                │
│  │  │                    │                               │                │
│  │  │                    └──► Multi-Review へ戻る        │                │
│  │  │                                                    │                │
│  │  ├── Count = 0, [DEFERRED] = 0 ──► PASSED            │                │
│  │  │                                                    │                │
│  │  └── Count = 0, [DEFERRED] > 0 ──► PASSED_WITH_DEFERRED │             │
│  │                                                       │                │
│  └─────────────────────┬───────────────────────────────┘                │
│                        │                                                 │
│              PASSED / PASSED_WITH_DEFERRED                               │
│                        │                                                 │
│                        ▼                                                 │
│              [HUMAN_CHECKPOINT]                                          │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Shared Workflows 依存関係

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    SHARED WORKFLOWS DEPENDENCIES                          │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                      CONSTITUTION LAYER                           │   │
│  │                                                                    │   │
│  │  core.md ◄─────────────────┐                                      │   │
│  │  quality-gates.md ◄────────┼───── すべてのワークフローが参照      │   │
│  │  terminology.md ◄──────────┤                                      │   │
│  │  spec-creation.md ◄────────┘                                      │   │
│  │                                                                    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│                                 ▼                                        │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                      SHARED LAYER                                 │   │
│  │                                                                    │   │
│  │  _clarify-gate.md ◄──── CLARIFY GATE 実行手順                     │   │
│  │        │                                                          │   │
│  │        └───► vision, add, fix, design, issue                      │   │
│  │                                                                    │   │
│  │  _quality-flow.md ◄──── Multi-Review + Lint 実行                  │   │
│  │        │                                                          │   │
│  │        └───► vision, add, fix, design, issue, change              │   │
│  │                                                                    │   │
│  │  _vision-interview.md ◄──── Vision Interview 3フェーズ            │   │
│  │        │                                                          │   │
│  │        └───► vision                                               │   │
│  │                                                                    │   │
│  │  _deep-interview.md ◄──── Deep Interview                         │   │
│  │        │                                                          │   │
│  │        └───► add, fix                                             │   │
│  │                                                                    │   │
│  │  _cascade-update.md ◄──── 関連Spec更新                           │   │
│  │        │                                                          │   │
│  │        └───► change                                               │   │
│  │                                                                    │   │
│  │  _finalize.md ◄──── 完了処理                                     │   │
│  │        │                                                          │   │
│  │        └───► vision, add, fix, design                             │   │
│  │                                                                    │   │
│  │  impact-analysis.md ◄──── 影響分析                               │   │
│  │        │                                                          │   │
│  │        └───► change, fix                                          │   │
│  │                                                                    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 5. スクリプト依存関係

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      SCRIPT DEPENDENCIES                                  │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  lib/index.cjs ──────────────────────────────────────────────────────┐  │
│       │                                                               │  │
│       ├── lib/paths.cjs ◄──── パス定義                               │  │
│       ├── lib/file-utils.cjs ◄──── ファイル操作                      │  │
│       ├── lib/matrix-utils.cjs ◄──── Matrix操作                      │  │
│       ├── lib/cli-utils.cjs ◄──── CLI・Git（遅延ロード）             │  │
│       └── lib/spec-parser.cjs ◄──── Spec解析（遅延ロード）           │  │
│                                                                       │  │
│  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │                     MAIN SCRIPTS                                 │ │  │
│  │                                                                   │ │  │
│  │  state.cjs ◄─────── branch-state.cjson 管理                     │ │  │
│  │       ▲                                                          │ │  │
│  │       │                                                          │ │  │
│  │  branch.cjs ─────► branch-state.cjson 更新                      │ │  │
│  │       │                                                          │ │  │
│  │       └───► scaffold-spec.cjs ★ specId未連携問題                │ │  │
│  │                    │                                             │ │  │
│  │                    └───► changelog.cjs                           │ │  │
│  │                                                                   │ │  │
│  │  spec-lint.cjs ◄───── Lint実行（lint.md から呼び出し）           │ │  │
│  │       │                                                          │ │  │
│  │       └───► pr.cjs ◄───── PR作成時にLint実行                    │ │  │
│  │                                                                   │ │  │
│  │  matrix-ops.cjs ◄────┬──── Matrix生成/検証                       │ │  │
│  │  validate-matrix.cjs ◄┘    ★ コード重複問題                      │ │  │
│  │  generate-matrix-view.cjs ◄── Markdown生成                       │ │  │
│  │                                                                   │ │  │
│  │  post-merge.cjs ◄───── マージ後自動処理                          │ │  │
│  │                                                                   │ │  │
│  │  update.cjs ◄───── テンプレート更新                              │ │  │
│  │                                                                   │ │  │
│  │  preserve-input.cjs ◄─┬── Input管理                              │ │  │
│  │  reset-input.cjs ◄────┘                                          │ │  │
│  │                                                                   │ │  │
│  │  spec-metrics.cjs ◄───── メトリクス収集                          │ │  │
│  │                                                                   │ │  │
│  └─────────────────────────────────────────────────────────────────┘ │  │
│                                                                       │  │
└───────────────────────────────────────────────────────────────────────┘  │
                                                                            │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 循環参照・問題箇所

```
⚠️ 検出された問題

┌──────────────────────────────────────────────────────────────────────────┐
│  ISSUE 1: 旧構造への参照残存                                              │
│                                                                          │
│  _vision-interview.md ───► spec-mesh-entry/workflows/vision.md          │
│  human-checkpoint-patterns.md ───► spec-mesh-*/workflows/*              │
│  _cascade-update.md ───► spec-mesh-meta/workflows/*                     │
│                                                                          │
│  ★ これらは spec-mesh/workflows/* への参照に更新が必要                   │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│  ISSUE 2: 重複定義                                                        │
│                                                                          │
│  guide/workflow-map.md ◄═════► spec-mesh/guides/workflow-map.md          │
│                        完全重複                                           │
│                                                                          │
│  ★ 一方を削除し、参照に置換が必要                                         │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│  ISSUE 3: スクリプト間の未連携                                            │
│                                                                          │
│  scaffold-spec.cjs ──X──► state.cjs (specId/specPath未設定)             │
│                                                                          │
│  ★ Spec生成後に自動でbranch-state.cjson更新が必要                        │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Spec階層構造

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         SPEC HIERARCHY                                    │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                    ┌─────────────────────┐                               │
│                    │    VISION SPEC      │                               │
│                    │  (プロジェクトの    │                               │
│                    │   北極星)           │                               │
│                    └──────────┬──────────┘                               │
│                               │                                          │
│              ┌────────────────┴────────────────┐                         │
│              │                                 │                         │
│              ▼                                 ▼                         │
│    ┌─────────────────┐               ┌─────────────────┐                │
│    │   SCREEN SPEC   │◄────────────►│   DOMAIN SPEC   │                │
│    │  (画面設計)      │   相互参照    │  (データ・API)   │                │
│    └────────┬────────┘               └────────┬────────┘                │
│             │                                 │                          │
│             │    ┌─────────────────────┐      │                          │
│             └────┤ CROSS-REFERENCE     ├──────┘                          │
│                  │ MATRIX              │                                 │
│                  │ (SCR-* ↔ M-*/API-*) │                                 │
│                  └──────────┬──────────┘                                 │
│                             │                                            │
│                             ▼                                            │
│                  ┌─────────────────────┐                                 │
│                  │   FEATURE SPEC      │                                 │
│                  │  (個別機能仕様)      │                                 │
│                  └──────────┬──────────┘                                 │
│                             │                                            │
│                             ▼                                            │
│                  ┌─────────────────────┐                                 │
│                  │ TEST SCENARIO SPEC  │                                 │
│                  │  (テストケース)      │                                 │
│                  └─────────────────────┘                                 │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

