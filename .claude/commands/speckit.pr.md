---
description: Verify integrity and create PR (Step 5). Final step before human review.
---

## Purpose

Step 5 of the 6-step workflow. Before creating a PR, this command:

1. Verifies spec-implementation integrity
2. Runs final checks (lint, tests)
3. Records any remaining feedback
4. Creates the PR with proper references

## Execution Protocol (MUST FOLLOW)

**Before starting:**

1. Use **TodoWrite** to create todos for all main Steps:
   - "Step 1: Integrity check"
   - "Step 2: Final feedback opportunity"
   - "Step 3: Run quality checks"
   - "Step 4: Generate PR content"
   - "Step 5: Create PR"
   - "Step 6: Update branch state"
   - "Step 7: Post-PR guidance"

**During execution:**

2. Before each Step: Mark the corresponding todo as `in_progress`
3. After each Step:
   - Run the **Self-Check** at the end of that Step
   - Only if Self-Check passes: Mark todo as `completed`
   - Output: `✓ Step N 完了: [1-line summary]`

**Rules:**

- **DO NOT** skip any Step
- **DO NOT** mark a Step as completed before its Self-Check passes
- If a Self-Check fails: Fix the issue before proceeding

## Steps

1. **Integrity check - Spec vs Implementation**:

   a) **Load context**:
   - Read spec from feature directory
   - Parse all UC/FR/SC IDs
   - List all implementation files changed (via git diff)

   b) **Verify coverage**:
   - For each UC: Is there at least one test?
   - For each FR: Is the requirement implemented?
   - Check test files for spec annotations (@spec, @uc, @fr)

   c) **Check for drift**:
   - Compare Implementation Notes in spec with actual implementation
   - Any undocumented deviations?
   - Any constraints discovered but not recorded?

   d) **Check for screen status updates**:
   - Read Feature Spec Section 8.3 (Screen Modifications)
   - Check Screen Spec Section 2.1 Modification Log for related entries
   - If Planned entries exist, flag for post-merge Status update to Implemented
   - Record affected SCR-\* IDs

   e) **Report findings**:

   ```
   Integrity Check Results:
   - UCs covered: 3/3
   - FRs implemented: 5/5
   - Tests with spec annotations: 8
   - Undocumented items: [list if any]
   - Screen Status updates needed: [SCR-* list with Planned status, or "None"]
   ```

#### Self-Check (Step 1)

- [ ] Read tool で Spec を読み込んだか
- [ ] git diff で変更ファイルを確認したか
- [ ] UC/FR カバレッジを報告したか

2. **Final feedback opportunity**:
   - If undocumented items found, ask human:
     ```
     Found undocumented items. Record as feedback?
     - [item 1]
     - [item 2]
     [Yes/No]
     ```
   - If yes, run `/speckit.feedback` for each item

3. **Run quality checks**:
   - spec-lint: `node .specify/scripts/spec-lint.cjs`
   - validate-matrix: `node .specify/scripts/validate-matrix.cjs`
   - Project lint (if configured): `npm run lint` or equivalent
   - Tests: `npm test` or configured test command
   - Build (if applicable): `npm run build`

   If any check fails:
   - Report the failure
   - Suggest fix or ask human how to proceed
   - Do NOT create PR with failing checks

#### Self-Check (Steps 2-3)

- [ ] 未ドキュメント項目があれば人間に確認したか
- [ ] spec-lint を実行したか
- [ ] validate-matrix を実行したか
- [ ] テストを実行したか
- [ ] 全てのチェックがパスしたか

4. **Generate PR content**:

   a) **Title** (auto-generated):
   - Feature: `feat: [spec title]`
   - Fix: `fix: [issue title]`

   b) **Body** (auto-generated):

   ```markdown
   ## Summary

   [Brief description from spec Purpose section]

   Fixes #[Issue]
   Implements [Spec IDs]

   ## Changes

   - [List of main changes]

   ## Test Plan

   - [x] Unit tests: [count] added/modified
   - [x] spec-lint: passed
   - [x] Build: passed

   ## Spec Compliance

   - UCs covered: [X/Y]
   - FRs implemented: [X/Y]

   ## Screen Status Updates (Post-Merge)

   [If Screen Spec has Planned entries for this feature:]

   - SCR-XXX: Planned → Implemented
   - SCR-YYY: Planned → Implemented (Modification Log)

   > **Note**: After merge, update Screen Spec Status to `Implemented`.

   [If no status updates needed:]

   - None

   ---

   [Auto-generated by /speckit.pr]
   ```

5. **Create PR**:
   - Run: `node .specify/scripts/pr.cjs --title "..." --body-file pr-body.md`
   - Display PR URL

6. **Update branch state**:

   ```bash
   node .specify/scripts/state.cjs branch --set-step pr
   ```

7. **Post-PR guidance**:

   ```
   PR created: [URL]

   Next steps:
   1. Review Codex/bot comments when they arrive
   2. Address any feedback (I can help with "fix PR feedback")
   3. Request human review
   4. Merge when approved
   ```

   **If screen status updates needed:**

   ```
   === Screen Spec Status 更新が必要 ===

   この PR がマージされた後、Screen Spec の Status を更新してください:

   | Screen ID | Current Status | Update To |
   |-----------|---------------|-----------|
   | SCR-XXX | Planned | Implemented |
   | SCR-YYY (Mod Log) | Planned | Implemented |

   マージ後の手順:
   1. `main` ブランチに切り替え
   2. Screen Spec の Status を更新:
      - `.specify/specs/screen/spec.md` を編集
      - Section 2 Screen Index: Status を Implemented に変更
      - Section 2.1 Modification Log: Status を Implemented に変更
   3. Changelog に記録:
      `| [DATE] | Implemented | [SCR-ID] implemented per [Feature ID] | #[PR] |`
   4. コミット & プッシュ（PR不要、直接 main へ）

   Note: Spec-First アプローチでは、ワイヤーフレームは既に
   Feature 作成時に計画状態として更新済みです。
   ```

#### Self-Check (Steps 4-7)

- [ ] PR タイトルとボディを生成したか
- [ ] gh pr create で PR を作成したか
- [ ] state.cjs を実行したか
- [ ] Post-PR guidance を出力したか
- [ ] 全ての Step が完了し、todo を全て `completed` にマークしたか

## Usage

Simply run `/speckit.pr` after completing implementation.
AI will auto-detect context from current branch and spec.

## Manual Override

If you need to customize:

```bash
node .specify/scripts/pr.cjs --title "custom title" --body "custom body" --test "npm test"
```

## Human Checkpoint

Human reviews and merges the PR. AI can assist with PR feedback fixes.
