# QA ドキュメント生成

Pre-Input を分析し、ユーザー向け QA ドキュメントを生成する共通コンポーネント。

## 設計思想

実際の SIer のワークフローを模倣：
1. **ドキュメント交換**: Pre-Input → QA ドキュメント → ユーザー回答
2. **MTG（対話）**: 未回答・不明項目のみ AskUserQuestion で確認

## 使用タイミング

| ワークフロー | トリガー | 出力先 |
|--------------|----------|--------|
| project-setup | Input 読み込み後 | `.specify/docs/project-setup-qa.md` |
| add | Input 読み込み後 | `.specify/specs/features/{feature-id}/qa.md` |
| fix | Input 読み込み後 | `.specify/specs/fixes/{fix-id}/qa.md` |

> **Note:** QA ドキュメントは対応する Spec と同じディレクトリに保存し、関連性を明確にする。

## QA ドキュメント構造

### 質問カテゴリ

| マーカー | 意味 | 必須度 | 例 |
|----------|------|--------|-----|
| `[必須]` | 必ず回答が必要 | 高 | 「対象ユーザーは誰ですか？」 |
| `[確認]` | AI の推測を確認 | 中 | 「〇〇と理解しましたが正しいですか？」 |
| `[提案]` | AI からの提案 | 低 | 「〇〇機能も必要では？」 |
| `[選択]` | 複数選択肢から選択 | 中 | 「認証方式は A/B/C どれですか？」 |

### セクション構成

```markdown
# {プロジェクト名/機能名} QA ドキュメント

**生成日:** {日付}
**ステータス:** 回答待ち / 回答済み / 確認完了

---

## 1. 基本情報 [必須]

### Q1.1: {質問} [必須]
回答:

### Q1.2: {質問} [確認]
AI の理解: {推測内容}
正しいですか？: [ ] はい / [ ] いいえ（→ 正しくは: ）

---

## 2. 機能要件

### Q2.1: {質問} [必須]
回答:

### Q2.2: {質問} [選択]
選択肢:
- [ ] A: {説明}
- [ ] B: {説明}
- [ ] C: {説明}

---

## 3. 非機能要件

### Q3.1: セキュリティ要件 [確認]
AI の推測: {推測}
追加要件:

### Q3.2: パフォーマンス要件 [確認]
AI の推測: 特になし
追加要件:

---

## 4. AI SIer からの提案

### P4.1: {提案タイトル} [提案]
**所見:** {理由}
**提案:** {内容}
採否: [ ] 採用 / [ ] 不採用 / [ ] 要検討

---

## 5. 確認事項

### C5.1: {確認タイトル} [確認]
{確認内容}
回答:
```

## 生成ロジック

### Step 1: Input 分析

```
1. Input ファイルを読み込み
2. 記入済み項目を抽出
3. 未記入・不明瞭な項目を特定
4. 推測可能な項目を AI が補完
```

### Step 2: 質問バンクから選択

**質問生成ルール:**
```
未記入項目 → [必須] 質問
推測項目 → [確認] 質問
選択が必要な項目 → [選択] 質問
```

**コンテキスト別に質問を選択:**

詳細は [質問バンク](#質問バンク) 参照。

### Step 3: 提案生成

```
_professional-proposals.md を参照
10 観点から提案を生成（提案 ID を付与）
```

### Step 4: QA ドキュメント出力

```
対応するディレクトリに出力:
- project-setup: .specify/docs/project-setup-qa.md
- add: .specify/specs/features/{feature-id}/qa.md
- fix: .specify/specs/fixes/{fix-id}/qa.md

ユーザーに回答を依頼
```

---

## 質問バンク

静的テンプレートではなく、Pre-Input の内容に応じて質問を動的に選択する。

### project-setup 質問バンク

| カテゴリ | 質問 ID | 質問 | 条件 |
|---------|---------|------|------|
| 基本情報 | PS-Q01 | プロジェクトの目的 [必須] | 常に |
| 基本情報 | PS-Q02 | 対象ユーザー [必須] | 常に |
| 基本情報 | PS-Q03 | 成功の定義 [確認] | 常に |
| 機能 | PS-Q10 | MVP 機能の確認 [確認] | 機能が特定された場合 |
| 機能 | PS-Q11 | 機能の優先順位 [選択] | 機能 >= 3 の場合 |
| 機能 | PS-Q12 | 認証方式 [選択] | ユーザー管理がある場合 |
| 画面 | PS-Q20 | 主要画面の確認 [確認] | 画面が特定された場合 |
| 画面 | PS-Q21 | 画面遷移 [確認] | 画面 >= 2 の場合 |
| データ | PS-Q30 | 主要エンティティ [確認] | データが特定された場合 |
| データ | PS-Q31 | データ量の見込み [選択] | 常に |
| 非機能 | PS-Q40 | セキュリティ要件 [確認] | 常に |
| 非機能 | PS-Q41 | 運用要件 [確認] | 常に |

### add 質問バンク

| カテゴリ | 質問 ID | 質問 | 条件 |
|---------|---------|------|------|
| 概要 | ADD-Q01 | 機能の目的 [必須] | 常に |
| 概要 | ADD-Q02 | 対象ユーザー [必須] | 常に |
| 概要 | ADD-Q03 | 解決する課題 [確認] | 常に |
| ストーリー | ADD-Q10 | 主要ユースケース [確認] | 常に |
| ストーリー | ADD-Q11 | エッジケース [確認] | 常に |
| 要件 | ADD-Q20 | 入力項目 [確認] | フォームがある場合 |
| 要件 | ADD-Q21 | 出力・表示項目 [確認] | 常に |
| 要件 | ADD-Q22 | バリデーション [確認] | 入力がある場合 |
| 関連 | ADD-Q30 | 使用データ（M-*/API-*）[確認] | 常に |
| 関連 | ADD-Q31 | 関連画面 [確認] | 常に |
| 非機能 | ADD-Q40 | パフォーマンス要件 [選択] | 常に |
| 非機能 | ADD-Q41 | 権限要件 [選択] | 常に |

### fix 質問バンク

| カテゴリ | 質問 ID | 質問 | 条件 |
|---------|---------|------|------|
| 概要 | FIX-Q01 | 問題の症状 [必須] | 常に |
| 概要 | FIX-Q02 | 発生条件 [必須] | 常に |
| 概要 | FIX-Q03 | 影響範囲 [確認] | 常に |
| 再現 | FIX-Q10 | 再現手順 [確認] | 常に |
| 再現 | FIX-Q11 | 再現率 [選択] | 常に |
| 期待動作 | FIX-Q20 | 本来の期待動作 [必須] | 常に |
| 期待動作 | FIX-Q21 | 現在の動作 [確認] | 常に |
| 原因 | FIX-Q30 | 推測される原因 [確認] | AI が推測可能な場合 |
| 原因 | FIX-Q31 | 関連ファイル [確認] | AI が特定可能な場合 |
| 方針 | FIX-Q40 | 緊急度 [選択] | 常に |
| 方針 | FIX-Q41 | 修正アプローチ [選択] | AI が提案可能な場合 |

### 動的生成の実装

```markdown
1. Input を分析し、記入済み/未記入項目を特定
2. コンテキスト（project-setup/add/fix）に応じた質問バンクを選択
3. 各質問の「条件」を評価し、必要な質問のみを含める
4. 未記入項目 → [必須] として質問
5. 推測可能項目 → [確認] として AI の推測を表示
6. 選択が必要 → [選択] として選択肢を提示
7. 提案 → _professional-proposals.md に従い生成
```

> **Note:** templates/qa/*.md は参考例として残すが、実際の生成は上記ロジックで動的に行う。

## 終了条件

以下を満たすと QA 完了：

1. 全ての `[必須]` 項目に回答あり
2. `[確認]` 項目の承認/却下が完了
3. `[提案]` 項目の採否が決定
4. Critical な曖昧点がない

## [NEEDS CLARIFICATION] 連携

**重要:** QA 完了後、未回答の `[必須]` 項目は Spec に `[NEEDS CLARIFICATION]` として反映される。

```
QA 分析時の判定:

[必須] 項目が未回答
    │
    ├─ AskUserQuestion で確認を試みる
    │       │
    │       ├─ 回答あり → Spec に反映
    │       │
    │       └─ 回答なし/不明確
    │               │
    │               └─ Spec の該当箇所に [NEEDS CLARIFICATION] を記入
    │                   → CLARIFY GATE でブロックされる
```

**実装詳細:**
- `_qa-analysis.md` Step 1.3 で未回答 [必須] を検出
- Spec 作成時、該当項目に `[NEEDS CLARIFICATION: {質問内容}]` を記入
- CLARIFY GATE で検出され、clarify ワークフローに誘導される

> **SSOT:** [quality-gates.md#clarify-gate](../../constitution/quality-gates.md#clarify-gate) 参照

## 次のステップ

QA 完了後 → `_qa-analysis.md` で回答を分析 → Spec 作成へ
