# QA フォローアップ

QA ドキュメントの回答を分析し、追加質問・提案確認を行う統合コンポーネント。

## 設計思想

QA ドキュメントには Input ベースの質問・提案が含まれる。
QA フォローアップでは、**回答を見て初めて分かる**追加の確認・提案を行う：

1. **回答分析** - 未回答項目のチェック、回答内容の構造化
2. **追加確認** - 回答から派生する疑問点・矛盾点の解消
3. **追加提案** - 回答内容から見えた新たな観点での提案

```
QA ドキュメント（Input ベース）
├─ [必須] / [確認] / [選択]
└─ [提案]（10 観点、Input 分析時点）
    ↓ ユーザー回答
QA フォローアップ（回答ベース）
├─ 未回答補完
├─ 回答ベースの追加確認（派生質問）
└─ 回答ベースの追加提案（回答で見えた新観点）
```

## 使用タイミング

| ワークフロー | トリガー | 参照 |
|--------------|----------|------|
| project-setup | QA ドキュメント回答後 | Step 4 |
| feature | QA ドキュメント回答後 | Step 3 |

> **Note:** fix ワークフローは簡易 AskUserQuestion を使用し、このコンポーネントは使用しない。

---

## フロー概要

```
QA ドキュメント回答
    ↓
┌─────────────────────────────────────────┐
│ QA フォローアップ                        │
│                                         │
│ 4.1 回答分析                            │
│     └─ 未回答項目のチェック              │
│     └─ [提案] の採否確認                 │
│     └─ 回答内容の構造化                  │
│                                         │
│ 4.2 追加確認（AskUserQuestion）          │
│     └─ 未回答 [必須] の補完              │
│     └─ 回答から派生する疑問点            │
│     └─ 矛盾点・曖昧点の解消              │
│                                         │
│ 4.3 追加提案（AskUserQuestion）          │
│     └─ 回答内容から見えた新たな観点      │
│     └─ QA ドキュメントになかった提案     │
│     └─ 重要な提案の採否確認              │
└─────────────────────────────────────────┘
    ↓
Spec 作成へ
```

---

## Step 4.1: 回答分析

### 1. マーカー別カウント

```
Grep tool:
  pattern: "\[必須\]"
  path: {qa-file-path}
  output_mode: count
```

同様に `[確認]`, `[提案]`, `[選択]` もカウント。

### 2. 回答状況サマリー

```markdown
=== QA 回答状況 ===

| マーカー | 総数 | 回答済 | 未回答 |
|----------|------|--------|--------|
| [必須]   | N    | n1     | N-n1   |
| [確認]   | M    | m1     | M-m1   |
| [提案]   | P    | p1     | P-p1   |
| [選択]   | S    | s1     | S-s1   |
```

### 3. 回答内容の構造化

QA 回答を Spec セクションにマッピング：

**project-setup の場合:**

| QA セクション | Spec セクション |
|--------------|----------------|
| 基本情報 | Vision Spec Section 1-2 |
| 機能要件 | Vision Spec Section 3 (Feature Hints) |
| 非機能要件 | Vision Spec Section 4 |
| 画面構成 | Screen Spec |
| データ項目 | Domain Spec |

**feature の場合:**

| QA セクション | Spec セクション |
|--------------|----------------|
| 機能目的 | Feature Spec Section 1 |
| ユーザーストーリー | Feature Spec Section 4 |
| 機能要件 | Feature Spec Section 5 |
| 関連データ | Feature Spec Section 2 |

---

## Step 4.2: 追加質問

### 質問の分類

| 分類 | トリガー | 優先度 |
|------|----------|--------|
| 未回答補完 | [必須] が未回答 | Critical |
| 派生質問 | 回答内容から新たな疑問が発生 | High |
| 矛盾解消 | 回答間に矛盾がある | High |
| 選択確認 | [選択] が未選択 | Medium |
| 推測確認 | [確認] で「いいえ」の項目 | Medium |

### 派生質問の例

| 回答内容 | 派生質問 |
|---------|---------|
| 「在庫管理あり」 | 「発注点アラートは必要？」「在庫履歴は保持する？」 |
| 「認証: OAuth」 | 「対応プロバイダーは？」「既存アカウント連携は？」 |
| 「データ量: 大規模」 | 「ページネーションの単位は？」「検索機能は必要？」 |
| 「権限管理あり」 | 「権限のレベルは？」「権限変更の承認フローは？」 |

### AskUserQuestion の実行

未回答・派生質問を最大 4 問ずつバッチで確認：

```
AskUserQuestion:
  questions:
    - question: "{質問1}"
      header: "Q1"
      options:
        - label: "オプションA"
          description: "説明A"
        - label: "オプションB"
          description: "説明B"
      multiSelect: false
    - question: "{質問2}"
      header: "Q2"
      ...
```

### 質問の優先順位

1. **Critical** - Spec 作成に必須な情報（未回答 [必須]）
2. **High** - 設計判断に影響する情報（派生質問、矛盾解消）
3. **Medium** - 確認が望ましい情報（選択、推測確認）

Critical と High のみ確認し、Medium は AI が妥当な値を推測。

---

## Step 4.3: 追加提案（回答ベース）

> **Note:** QA ドキュメントには Input ベースの提案が含まれている。
> ここでは**回答を見て初めて分かる**追加の提案を行う。

### Input ベース vs 回答ベース

| タイミング | 提案の根拠 | 例 |
|-----------|-----------|-----|
| QA ドキュメント生成時 | Input の内容のみ | 「認証がないのでセキュリティ提案」 |
| QA フォローアップ時 | 回答内容 | 「在庫管理ありなら発注点アラート提案」 |

### 追加提案のトリガー

| 回答内容 | 追加提案 | 観点 |
|---------|---------|------|
| 「在庫管理あり」 | 発注点アラート、在庫履歴 | 機能追加 |
| 「認証: OAuth」 | 複数プロバイダー対応、アカウント連携 | 機能追加 |
| 「データ量: 大規模」 | ページネーション、検索機能 | パフォーマンス |
| 「権限管理あり」 | 監査ログ、権限変更承認フロー | セキュリティ/保守性 |
| 「外部 API 連携」 | リトライ機構、タイムアウト設定 | 信頼性 |

### 追加提案の生成

QA 回答を分析し、QA ドキュメントになかった観点から提案：

```markdown
=== 追加提案（回答ベース） ===

| ID | 観点 | 提案 | トリガーとなった回答 | 優先度 |
|----|------|------|---------------------|--------|
| P-F01 | 機能追加 | 発注点アラート | 「在庫管理あり」 | 中 |
| P-F02 | パフォーマンス | 検索機能の追加 | 「データ量: 大規模」 | 高 |
```

### 重要な提案の確認

優先度「高」の追加提案は AskUserQuestion で確認：

```
AskUserQuestion:
  questions:
    - question: "大規模データに対応するため検索機能を追加することを提案します。採用しますか？"
      header: "検索機能"
      options:
        - label: "採用する（推奨）"
          description: "キーワード検索とフィルタリングを導入"
        - label: "後で検討"
          description: "MVP では見送り、Phase 2 で対応"
        - label: "不要"
          description: "現状のリスト表示で対応"
      multiSelect: false
```

### 全提案の採否記録（QA + フォローアップ）

```markdown
=== 提案採否サマリー ===

【QA ドキュメントの提案】
| ID | 提案内容 | 採否 | 理由 | 反映先 |
|----|---------|------|------|--------|
| P-001 | 権限管理 | 採用 | セキュリティ要件 | 非機能要件に追加 |
| P-002 | エラーメッセージ改善 | 後回し | Phase 2 | [DEFERRED] |

【追加提案（フォローアップ）】
| ID | 提案内容 | 採否 | 理由 | 反映先 |
|----|---------|------|------|--------|
| P-F01 | 発注点アラート | 採用 | 在庫管理に必須 | Feature Hints に追加 |
| P-F02 | 検索機能 | 採用 | 大規模データ対応 | Feature Hints に追加 |
```

> **重要:** 不採用・要検討の理由は、後の意思決定の参考になるため必ず記録する。

---

## [NEEDS CLARIFICATION] マーカー生成

**未回答 [必須] が残った場合の処理:**

```markdown
# Spec 作成時のマーカー生成例

## Before (QA 未回答 + AskUserQuestion でも未回答)
Q1.2: 対象ユーザーは誰ですか？ [必須]
回答: (未記入)

## After (Spec 内)
### 3. Actors
[NEEDS CLARIFICATION: 対象ユーザーの特定が必要。ユーザーロールと権限を明確にしてください。]
```

**重要ルール:**
1. `[NEEDS CLARIFICATION]` は具体的な質問内容を含める
2. どの Spec セクションに配置するかは QA→Spec マッピングに従う
3. マーカーがある Spec は SPEC GATE で BLOCKED_CLARIFY となる

---

## [DEFERRED] マーカーの取り扱い

**重要:** `[DEFERRED]` マーカーは clarify ワークフローで意図的に付与されたものであり、QA フォローアップで変更しない。

```
[DEFERRED] の処理ルール:

1. 既存の [DEFERRED] マーカーは保持する
2. [DEFERRED] を [NEEDS CLARIFICATION] に変換しない
3. SPEC GATE は [DEFERRED] を PASSED_WITH_DEFERRED として処理

# 例：既存の [DEFERRED] がある Spec
### 4. Non-Functional Requirements
[DEFERRED:PERF-001] パフォーマンス要件は負荷テスト後に決定

→ QA フォローアップ後も上記マーカーは変更せず保持
```

**[DEFERRED] vs [NEEDS CLARIFICATION]:**

| マーカー | 意味 | SPEC GATE |
|---------|------|--------------|
| `[NEEDS CLARIFICATION]` | 解消必須の曖昧点 | BLOCKED_CLARIFY |
| `[PENDING OVERVIEW CHANGE]` | Overview Spec への変更が必要 | BLOCKED_OVERVIEW |
| `[DEFERRED:*]` | 意図的に後回しにした項目 | PASSED_WITH_DEFERRED |

> **SSOT:** [quality-gates.md#spec-gate](../../constitution/quality-gates.md#spec-gate) 参照

---

## 出力

フォローアップ完了後、以下を出力：

```markdown
=== QA フォローアップ完了 ===

【回答状況】
- [必須]: 5/5 (100%)
- [確認]: 3/4 (75%) - 1件は AI 推測採用
- [提案]: 3/4 決定済み (1件 [DEFERRED])
- [選択]: 2/2 (100%)

【追加確認】
- 派生質問: 2 件 → 回答済み
- 矛盾解消: 0 件

【提案の採否（QA ドキュメント）】
| ID | 提案 | 採否 | 理由 |
|----|------|------|------|
| P-001 | 権限管理 | 採用 | セキュリティ要件 |
| P-002 | エラーメッセージ | 後回し | Phase 2 予定 |

【追加提案（フォローアップ）】
| ID | 提案 | 採否 | 理由 |
|----|------|------|------|
| P-F01 | 発注点アラート | 採用 | 在庫管理に必須 |
| P-F02 | 検索機能 | 採用 | 大規模データ対応 |

【Spec 反映状況】
- [NEEDS CLARIFICATION]: 0 件
- [DEFERRED]: 1 件（既存を保持）

Spec 作成に進みます。

{[NEEDS CLARIFICATION] > 0 の場合}
⚠️ 未解決の必須項目があります:
- Section X: [NEEDS CLARIFICATION: {質問内容}]

→ Spec 作成後、SPEC GATE でブロックされます。
→ clarify ワークフロー で解消してください。
```

---

## 提案しない場合

以下の場合は提案を控える：

1. ユーザーが明示的に「シンプルに」と要望
2. MVP/PoC フェーズで明確にスコープ外
3. 技術的に実現困難
4. コスト対効果が明らかに低い

---

## 次のステップ

フォローアップ完了 → Spec 作成（Vision/Feature）
